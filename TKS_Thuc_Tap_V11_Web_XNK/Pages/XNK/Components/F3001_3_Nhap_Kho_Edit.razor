@using TKS_Thuc_Tap_V11_Data_Access.Controller.XNK
@using TKS_Thuc_Tap_V11_Data_Access.Entity.XNK
@inherits FBase_Edit;

<div class="modal fade show" tabindex="-1" role="dialog" aria-hidden="true" style="display: block; padding-left: 0px; background-color: rgba(10, 10, 10, .8);">
	<div class="modal-dialog" style="max-height: 90vh; overflow-y:auto;">
		<div class="modal-content" style="overflow-y: auto;">
			<div class="modal-header bg-light">
				@if (r_iAuto_ID != 0)
				{
					<h5 class="modal-title">@Get_Language_Data_Field("Hiệu chỉnh")</h5>
				}
				else
				{
					<h5 class="modal-title">@Get_Language_Data_Field("Thêm mới")</h5>
				}
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" @onclick="@(()=> Modal_Cancel())">
				</button>
			</div>

			@{
				Check_Exception_Edit_Raw_Mode();
			}
			
			@((MarkupString)r_strError)

			<EditForm Model="@m_objData">
				<div class="modal-body">
					<div class="row">
						<div class="col-lg-12">
							<div class="row mb-1">
								<div class="col-lg-4 col-form-label">
									<label class="form-label">@Get_Language_Data_Field("Số phiếu nhập kho"):</label>
								</div>
								<div class="col-lg-8">
									<input @ref="txtFocus" @bind="@m_objData.So_Phieu_Nhap_Kho" class="form-control">

								</div>
							</div>

							<div class="row mb-1">
								<div class="col-lg-4 col-form-label">
									<label class="form-label">@Get_Language_Data_Field("Kho"):</label>
								</div>
								<div class="col-lg-8">
									<FControl_Kho_Combo 
										m_arrData="@m_arrKho"
										@bind-BindingValue="@m_objData.Kho_ID">
									</FControl_Kho_Combo>

								</div>
							</div>

							<div class="row mb-1">
								<div class="col-lg-4 col-form-label">
									<label class="form-label">@Get_Language_Data_Field("Nhà cung cấp"):</label>
								</div>
								<div class="col-lg-8">
									<FControl_NCC_Combo 
										m_arrData="@m_arrNCC"
										@bind-BindingValue="@m_objData.NCC_ID" >
									</FControl_NCC_Combo>

								</div>
							</div>

							<div class="row mb-1">
								<div class="col-lg-4 col-form-label">
									<label class="form-label">@Get_Language_Data_Field("Ngày nhập kho"):</label>
								</div>
								<div class="col-lg-8">
									<TelerikDatePicker @bind-Value="@m_objData.Ngay_Nhap_Kho" Format="@CConfig.Date_Format_String"></TelerikDatePicker>

								</div>
							</div>

							<div class="row mb-1">
								<div class="col-lg-4 col-form-label">
									<label class="form-label">@Get_Language_Data_Field("Ghi chú"):</label>
								</div>
								<div class="col-lg-8">
									<input @bind="@m_objData.Ghi_Chu" class="form-control">

								</div>
							</div>

						</div>
					</div>

				</div>
			</EditForm>

            @* Bắt đầu phần hiển thị dữ liệu nhập kho raw data *@
			<button type="button" class="btn rounded btn-primary waves-effect waves-light" @onclick="@(() => Open_2009_3_Nhap_Kho_Raw_Data_Edit(0))">
				<i class="ri-add-circle-fill align-bottom me-1"></i>
				@Get_Language_Data_Field("Thêm chi tiết phiếu nhập")
			</button>
			<div style="padding-top: 10px;"></div>

			<div class="row">
				<div class="col-lg-12">

					<TelerikGrid Data="@m_arrNhap_Kho_Raw_Data" Height="calc(100vh - 470px)" Resizable="true" Reorderable="true" @ref="@m_grdNhap_Kho_Raw_Data">
						@* <GridExport>
							<GridExcelExport FileName="Nhap_Kho_Raw_Data_Export" AllPages="true" />
							<GridCsvExport FileName="Nhap_Kho_Raw_Data_Export" AllPages="true" />
						</GridExport> *@
						<GridColumns>
							<GridCheckboxColumn SelectAll="true" CheckBoxOnlySelection="true" Width="30px"></GridCheckboxColumn>
							<GridColumn Width="60px">

								<Template>
									<button class="btn btn-link" @onclick="@(() => Open_Info((context as CXNK_Nhap_Kho_Raw_Data).Auto_ID))">
										<i class="mdi mdi-eye" style="color: purple;"></i>
									</button>
									&nbsp;
									<button class="btn btn-link" data-bs-toggle="dropdown" aria-expanded="false">
										<i class="mdi mdi-cog-outline" style="color: purple;"></i>
									</button>
									<ul class="dropdown-menu">
										@if (r_objChuc_Nang.Is_Have_Edit_Permission == true)
										{
											<li>
												<button class="dropdown-item" type="button" @onclick="@(() => Open_2009_3_Nhap_Kho_Raw_Data_Edit((context as CXNK_Nhap_Kho_Raw_Data).Auto_ID))"><i class="ri-edit-2-line align-bottom me-1"></i> &nbsp; @Get_Language_Data_Field("Hiệu chỉnh")</button>
											</li>
										}
										@if (r_objChuc_Nang.Is_Have_Delete_Permission == true)
										{
											<li>
												<button class="dropdown-item" type="button" @onclick="@(() => Delete_Data((context as CXNK_Nhap_Kho_Raw_Data).Auto_ID))"><i class="ri-delete-bin-line align-bottom me-1"></i> &nbsp; @Get_Language_Data_Field("Xóa")</button>
											</li>
										}
									</ul>
								</Template>
							</GridColumn>
							@if (CCache_Grid_UI_Global.List_Data_By_Code("2009", "grdData").Count > 0)
							{
								<FCommon_General_Col_Grid m_strFCode="2009" m_strTen_Grid="grdData"></FCommon_General_Col_Grid>
							}
							else
							{
								<GridColumn Field="Ten_San_Pham" Title="Sản Phẩm" Width="100px"></GridColumn>
								<GridColumn Field="SL_Nhap" Title="Số lượng nhập" Width="100px"></GridColumn>
								<GridColumn Field="Don_Gia_Nhap" Title="Đơn giá nhập" Width="100px"></GridColumn>
								@* <GridColumn Field="" Title=""><FooterTemplate Context="Footer"></FooterTemplate></GridColumn> *@
							}
						</GridColumns>
					</TelerikGrid>
				</div>
			</div>

			


			<div class="modal-footer">
				<button type="button" class="btn btn-primary" @onclick="@Check_Before_Save">@Get_Language_Data_Field("Lưu Thay Đổi")</button>
			</div>
		</div>
	</div>
</div>

@if (m_bIs_Show_2009_3_Nhap_Kho_Raw_Data_Edit == true)
{
	if (m_isEditRawMode)
	{
		<F3002_3_Nhap_Kho_Raw_Data_Edit 
			r_iAuto_ID="@m_objObject_Delivery_For_Edit.Auto_ID" 
			OnClose_2009="@Close_2009_3_Nhap_Kho_Raw_Data_Edit"
			m_isEditRawMode="@m_isEditRawMode"
			m_objObject_Delivery_For_Edit="@m_objObject_Delivery_For_Edit"
		>
		</F3002_3_Nhap_Kho_Raw_Data_Edit>
	}
	else
	{
		<F3002_3_Nhap_Kho_Raw_Data_Edit r_iAuto_ID="@r_iAuto_ID"
										OnClose_2009="@Close_2009_3_Nhap_Kho_Raw_Data_Edit"
										m_isEditRawMode="@m_isEditRawMode"
										m_objObject_Delivery_For_Edit="@m_objObject_Delivery_For_Edit">
		</F3002_3_Nhap_Kho_Raw_Data_Edit>
	}
}

@code {
	private CXNK_Nhap_Kho m_objData = new();
	private List<CXNK_Nhap_Kho_Raw_Data> m_arrNhap_Kho_Raw_Data = new();
	private TelerikGrid<CXNK_Nhap_Kho_Raw_Data> m_grdNhap_Kho_Raw_Data = new();
	private List<CDM_NCC> m_arrNCC = new();
	private List<CDM_Kho> m_arrKho = new();
	private bool m_bIs_Show_2009_3_Nhap_Kho_Raw_Data_Edit = false;
	private bool m_isEditRawMode = false;

	// index của mảng raw data nhập kho, dùng để tạo Auto_ID tạm thời cho các bản ghi mới
	private int m_iIndex_Nhap_Kho_Raw = 1;

	// Biến này dùng để lưu index của raw data nhập kho khi mở form hiệu chỉnh
	private CXNK_Nhap_Kho_Raw_Data m_objObject_Delivery_For_Edit = new();


	protected override void Init_Data()
	{
		CCache_NCC.Load_Cache_DM_NCC();
		CCache_San_Pham.Load_Cache_DM_San_Pham();
		CCache_Kho.Load_Cache_DM_Kho();
		m_arrNCC = CCache_NCC.List_Data();
		m_arrKho = CCache_Kho.List_Data();
	}

	protected override void Load_Data()
	{
		// đoan code này sẽ được gọi khi mở form hiệu chỉnh hoặc thêm mới
		// phần nhập kho
		CXNK_Nhap_Kho_Controller v_objCtrNhapKhoData = new();
		m_objData = v_objCtrNhapKhoData.FQ_718_NK_sp_sel_Get_By_ID(r_iAuto_ID);


		if (m_objData == null)
			m_objData = new CXNK_Nhap_Kho();
		else
		{
			r_bUpdate = true;

			// Đoạn code lưu key cho việc tracking log CRUD, vui lòng đừng xóa
			CXNK_Nhap_Kho v_objClone = new();
			CUtility.Clone_Entity(m_objData, v_objClone);
			r_objSource = v_objClone;
			// End tracking
		}

		// phần raw data
		CXNK_Nhap_Kho_Raw_Data_Controller v_objCtrNhapKhoRawData = new();

		//Format lại grid đúng chuẩn, Đặt trước hàm load dữ liệu vì nó sẽ chạy nhanh hơn
		Format_Grid(m_grdNhap_Kho_Raw_Data);

		if (r_iAuto_ID != 0)
		{
			m_arrNhap_Kho_Raw_Data = v_objCtrNhapKhoRawData.F3001_sp_sel_List_NKRD_By_Nhap_Kho_ID(r_iAuto_ID);
			foreach (var item in m_arrNhap_Kho_Raw_Data)
			{
				item.Ten_San_Pham = CCache_San_Pham.Get_Data_By_ID(item.San_Pham_ID).Ten_San_Pham ?? "";
			}
		}

	}

	protected override void Add_Data()
	{
		// Phần lưu thông tin phiếu nhập
		CXNK_Nhap_Kho_Controller v_objCtrData = new();
		// m_objData.Kho_ID = r_iKho_ID;
		m_objData.Last_Updated_By = r_strActive_User_Name;
		m_objData.Last_Updated_By_Function = r_strActive_Function_Code;

		m_objData.Auto_ID = r_iAuto_ID = v_objCtrData.FQ_718_NK_sp_ins_Insert(m_objData);

		// Đoạn code lưu key cho việc tracking log CRUD, vui lòng đừng xóa
		r_strAdd_Key = m_objData.So_Phieu_Nhap_Kho;
		// End tracking


		// Phần lưu thông tin raw data nhập kho - chi tiết phiếu nhập
		CXNK_Nhap_Kho_Raw_Data_Controller v_objCtrNhapKhoRawData = new();
		foreach (var item in m_arrNhap_Kho_Raw_Data)
		{
			item.Nhap_Kho_ID = r_iAuto_ID; // Gán ID phiếu nhập kho cho raw data
			item.Last_Updated_By = r_strActive_User_Name;
			item.Last_Updated_By_Function = r_strActive_Function_Code;
			item.Auto_ID = v_objCtrNhapKhoRawData.FQ_719_NKRD_sp_ins_Insert(item);
			// Đoạn code lưu key cho việc tracking log CRUD, vui lòng đừng xóa
			r_strAdd_Key = item.SL_Nhap.ToString();
			// End tracking
		}

		m_isEditRawMode = false; // Reset chế độ hiệu chỉnh raw data sau khi lưu
	}

	protected override void Update_Data()
	{

		CXNK_Nhap_Kho_Controller v_objCtrData = new();
		m_objData.Last_Updated_By = r_strActive_User_Name;
		m_objData.Last_Updated_By_Function = r_strActive_Function_Code;

		v_objCtrData.FQ_718_NK_sp_upd_Update(m_objData);

		// Đoạn code lưu key cho việc tracking log CRUD, vui lòng đừng xóa
		CXNK_Nhap_Kho v_objClone = new();
		CUtility.Clone_Entity(m_objData, v_objClone);
		r_objDes = v_objClone;
		// End tracking
	}


	void Open_2009_3_Nhap_Kho_Raw_Data_Edit(long p_iAuto_ID = 0)
	{

		m_bIs_Show_2009_3_Nhap_Kho_Raw_Data_Edit = true;
		if(r_iAuto_ID == 0) m_isEditRawMode = true;

		if (p_iAuto_ID != 0)
			m_objObject_Delivery_For_Edit = m_arrNhap_Kho_Raw_Data.Find(x => x.Auto_ID == p_iAuto_ID);

		StateHasChanged();
	}

	async Task Close_2009_3_Nhap_Kho_Raw_Data_Edit(CEvent_Call_Back p_objEvent)
	{
		if (p_objEvent.Message_ID == (int)EModal_Result.Close_And_Reload_Data || p_objEvent.Message_ID == (int)EModal_Result.Close_Cancel)
		{
			m_objObject_Delivery_For_Edit = new();
		}

		if (p_objEvent.Message_ID == (int)EModal_Result.Close_And_Reload_Data)
		{
			if (p_objEvent.Object_1 is CXNK_Nhap_Kho_Raw_Data && m_isEditRawMode)
			{
				CXNK_Nhap_Kho_Raw_Data m_objHandle = p_objEvent.Object_1 as CXNK_Nhap_Kho_Raw_Data;
				if (m_objHandle.Auto_ID != 0)
				{
					CXNK_Nhap_Kho_Raw_Data v_objHandle = m_arrNhap_Kho_Raw_Data.Find(x => x.Auto_ID == m_objHandle.Auto_ID);
					CUtility.Clone_Entity(m_objHandle, v_objHandle);
					m_objObject_Delivery_For_Edit = new();
					m_grdNhap_Kho_Raw_Data.Rebind();
				}
				else
				{
					m_objHandle.Ten_San_Pham = CCache_San_Pham.Get_Data_By_ID(m_objHandle.San_Pham_ID).Ten_San_Pham ?? "";
					// Tạo Auto_ID tạm thời để hiển thị trên grid
					m_objHandle.Auto_ID = m_iIndex_Nhap_Kho_Raw++;
					m_arrNhap_Kho_Raw_Data.Add(m_objHandle);
					m_grdNhap_Kho_Raw_Data.Rebind();
				}
			}
			else
			{
				// Nếu không phải là chế độ hiệu chỉnh raw data, thì chỉ cần cập nhật lại dữ liệu
				CXNK_Nhap_Kho_Raw_Data v_objReceiveFromParent = p_objEvent.Object_1 as CXNK_Nhap_Kho_Raw_Data;
				if (p_objEvent.Message_Description == "Add")
				{
					v_objReceiveFromParent.Ten_San_Pham = CCache_San_Pham.Get_Data_By_ID(v_objReceiveFromParent.San_Pham_ID).Ten_San_Pham ?? "";
					m_arrNhap_Kho_Raw_Data.Add(v_objReceiveFromParent);
					m_grdNhap_Kho_Raw_Data.Rebind();
				}
				else
				{
					CXNK_Nhap_Kho_Raw_Data v_objHandle = m_arrNhap_Kho_Raw_Data.Find(x => x.Auto_ID == v_objReceiveFromParent.Auto_ID);
					CUtility.Clone_Entity(v_objReceiveFromParent, v_objHandle);
					v_objHandle.Ten_San_Pham = CCache_San_Pham.Get_Data_By_ID(v_objHandle.San_Pham_ID).Ten_San_Pham ?? "";
					m_objObject_Delivery_For_Edit = new();
					m_grdNhap_Kho_Raw_Data.Rebind();
				}
			}

		}

		m_bIs_Show_2009_3_Nhap_Kho_Raw_Data_Edit = false;
	}

	// hàm kiểm tra trước khi lưu dữ liệu
	public async Task Check_Before_Save()
	{
		string v_strErrorMessage = "";
		if (!m_objData.IsValid(out v_strErrorMessage))
		{
			r_strError = CCommonFunction.Set_Error_MessageBox(v_strErrorMessage);
			return;
		}

		if (m_arrNhap_Kho_Raw_Data.Count == 0 && !r_bUpdate)
		{
			r_strError = CCommonFunction.Set_Error_MessageBox("Vui lòng thêm chi tiết phiếu nhập kho");
			return;
		}

		CXNK_Nhap_Kho_Controller v_objCtrData = new();
		List<CXNK_Nhap_Kho> v_arrNhap_Kho = v_objCtrData.F3001_sp_sel_List_NK_By_Created();

		foreach (var item in v_arrNhap_Kho)
		{
			if ( item.So_Phieu_Nhap_Kho.Equals(m_objData.So_Phieu_Nhap_Kho, StringComparison.Ordinal) 
				&& m_objData.Auto_ID != item.Auto_ID)
			{
				r_strError = CCommonFunction.Set_Error_MessageBox("Số phiếu nhập kho đã tồn tại");
				return;
			}
		}
				
		await Save_Data();
	}

	protected override void Delete_Data_Entry(long p_iAuto_ID)
	{
		if (m_isEditRawMode)
		{
			CXNK_Nhap_Kho_Raw_Data v_objHandle = m_arrNhap_Kho_Raw_Data.Find(x => x.Auto_ID == p_iAuto_ID);
			m_arrNhap_Kho_Raw_Data.Remove(v_objHandle);
			m_grdNhap_Kho_Raw_Data.Rebind();
			throw new Exception("");
		}

		CXNK_Nhap_Kho_Raw_Data_Controller v_objCtrData = new();

		// Đoạn code lưu key cho việc tracking log CRUD, vui lòng đừng xóa
		CXNK_Nhap_Kho_Raw_Data v_objData = v_objCtrData.FQ_719_NKRD_sp_sel_Get_By_ID(p_iAuto_ID);
		if (v_objData != null)
			r_strDelete_Key = v_objData.Auto_ID.ToString();
		// End tracking

		v_objCtrData.FQ_719_NKRD_sp_del_Delete_By_ID(p_iAuto_ID, r_strActive_User_Name, r_strActive_Function_Code);
	}

	void Check_Exception_Edit_Raw_Mode()
	{
		if (r_strError == CCommonFunction.Set_Error_MessageBox(""))
		{
			r_strError = "";
		}
	}
}
